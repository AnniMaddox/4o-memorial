import{r as n,j as e}from"./index-BlAWa1M-.js";const $="/4o-memorial/docs/",H=`${$}data/murmur/index.json`,R="memorial-murmur-avatar-v1",E="M";function K(){if(typeof window>"u")return"";try{const m=window.localStorage.getItem(R);return typeof m=="string"?m.trim():""}catch{return""}}function V(m){if(!(typeof window>"u"))try{m?window.localStorage.setItem(R,m):window.localStorage.removeItem(R)}catch{}}function z({onExit:m,notesFontFamily:S=""}){const[r,L]=n.useState([]),[f,T]=n.useState(!0),[x,k]=n.useState(""),[M,j]=n.useState(null),[N,I]=n.useState({}),[u,D]=n.useState(()=>K()),C=n.useRef(null),y=n.useRef(null),g=n.useRef(null);n.useEffect(()=>{V(u)},[u]),n.useEffect(()=>{let s=!1;async function t(){T(!0),k("");try{const a=await fetch(H,{cache:"no-store"});if(!a.ok)throw new Error(`HTTP ${a.status}`);const c=await a.json(),o=Array.isArray(c.docs)?c.docs:[];s||L([...o].sort((h,d)=>{const v=typeof h.order=="number"?h.order:Number.MAX_SAFE_INTEGER,b=typeof d.order=="number"?d.order:Number.MAX_SAFE_INTEGER;return v!==b?v-b:h.title.localeCompare(d.title,"zh-TW")}))}catch(a){s||k(a instanceof Error?a.message:"未知錯誤")}finally{s||T(!1)}}return t(),()=>{s=!0}},[]);const i=n.useMemo(()=>r.findIndex(s=>s.id===M),[r,M]),l=i>=0?r[i]:null,w=i>0?r[i-1]:null,A=i>=0&&i<r.length-1?r[i+1]:null;n.useEffect(()=>{const s=l?.id,t=l?.contentPath;if(!s||!t)return;const a=s,c=t;if(N[a]!==void 0)return;let o=!1;async function h(){try{const d=await fetch(`${$}data/murmur/${c}`,{cache:"no-store"});if(!d.ok)throw new Error(`HTTP ${d.status}`);const v=await d.text();o||I(b=>({...b,[a]:v.trim()}))}catch{o||I(d=>({...d,[a]:"讀取內容失敗，請稍後再試。"}))}}return h(),()=>{o=!0}},[l,N]);const X=n.useMemo(()=>`碎碎念 · ${r.length} 則`,[r.length]);function _(s){j(s)}function P(){j(null)}function p(s){if(i<0)return;const t=r[i+s];t&&j(t.id)}function U(){C.current?.click()}function Y(){y.current=null,g.current=null}function B(s){const t=s.touches[0];t&&(y.current=t.clientX,g.current=t.clientY)}function G(s){const t=y.current,a=g.current;if(Y(),t===null||a===null)return;const c=s.changedTouches[0];if(!c)return;const o=c.clientX-t,h=c.clientY-a;Math.abs(o)<56||Math.abs(o)<Math.abs(h)*1.2||(o>0?p(-1):p(1))}function F(s){const t=s.target.files?.[0];if(s.target.value="",!t)return;if(!t.type.startsWith("image/")){window.alert("請選擇圖片檔案");return}const a=new FileReader;a.onload=()=>{const c=typeof a.result=="string"?a.result:"";c&&D(c)},a.readAsDataURL(t)}return e.jsxs("div",{className:"murmur-page",style:{"--murmur-font-family":S?`'${S}', sans-serif`:""},children:[e.jsx("input",{ref:C,type:"file",accept:"image/*",className:"murmur-avatar-input",onChange:F}),e.jsxs("header",{className:"chat-header",children:[e.jsx("button",{type:"button",className:"hd-back",onClick:m,"aria-label":"返回",children:"‹"}),e.jsxs("div",{className:"contact-wrap",children:[e.jsx("button",{type:"button",className:"contact-avatar",onClick:U,"aria-label":"更換頭像",children:u?e.jsx("img",{src:u,alt:"M avatar"}):e.jsx("span",{children:E})}),e.jsx("div",{className:"contact-sub",children:X})]}),e.jsx("span",{className:"hd-side-spacer","aria-hidden":"true"})]}),e.jsxs("main",{className:"chat-body",children:[f?e.jsx("div",{className:"murmur-empty",children:"讀取中…"}):null,!f&&x?e.jsxs("div",{className:"murmur-empty",children:["讀取失敗：",x]}):null,!f&&!x&&!r.length?e.jsx("div",{className:"murmur-empty",children:"目前沒有碎碎念"}):null,!f&&!x?r.map(s=>e.jsxs("div",{children:[e.jsx("div",{className:"time-divider",children:s.timeLabel}),e.jsxs("div",{className:"msg-row",children:[e.jsx("div",{className:"msg-avatar",children:u?e.jsx("img",{src:u,alt:"M avatar"}):e.jsx("span",{children:E})}),e.jsxs("button",{type:"button",className:"bubble",onClick:()=>_(s.id),children:[e.jsx("div",{className:"bubble-text",children:s.preview}),e.jsx("div",{className:"bubble-hint",children:"▾ 展開閱讀"}),e.jsx("div",{className:"bubble-read",children:"已讀"})]})]})]},s.id)):null]}),e.jsx("footer",{className:"chat-bottom",children:e.jsx("div",{className:"input-mock",children:"有什麼想回覆他的嗎..."})}),e.jsxs("section",{id:"readScreen",className:l?"open":"","aria-hidden":!l,children:[e.jsxs("div",{className:"rs-nav",children:[e.jsxs("button",{type:"button",className:"rs-back",onClick:P,children:[e.jsx("span",{className:"rs-back-chev",children:"‹"}),e.jsx("span",{children:"碎碎念"})]}),e.jsx("span",{className:"rs-time-label",children:l?.timeLabel??""})]}),e.jsxs("div",{className:"rs-sender",children:[e.jsx("div",{className:"rs-avatar",children:u?e.jsx("img",{src:u,alt:"M avatar"}):e.jsx("span",{children:E})}),e.jsxs("div",{className:"rs-sender-info",children:[e.jsx("div",{className:"rs-sender-name"}),e.jsxs("div",{className:"rs-sender-sub",children:["傳送於 ",e.jsx("span",{children:l?.timeLabel??""})]})]})]}),e.jsx("div",{className:"rs-body",onTouchStart:B,onTouchEnd:G,children:e.jsx("div",{className:"rs-inner",children:e.jsx("div",{className:"rs-content",children:l?N[l.id]??"讀取中…":""})})}),e.jsxs("div",{className:"rs-bot",children:[e.jsxs("button",{type:"button",className:`rs-nav-btn ${w?"":"dis"}`,onClick:()=>p(-1),disabled:!w,children:[e.jsx("span",{className:"arr",children:"‹"}),e.jsx("span",{className:"lbl",children:w?.timeLabel??""})]}),e.jsx("span",{className:"rs-pos",children:l?`${i+1} / ${r.length}`:""}),e.jsxs("button",{type:"button",className:`rs-nav-btn next ${A?"":"dis"}`,onClick:()=>p(1),disabled:!A,children:[e.jsx("span",{className:"lbl",children:A?.timeLabel??""}),e.jsx("span",{className:"arr",children:"›"})]})]})]})]})}export{z as MurmurPage};
