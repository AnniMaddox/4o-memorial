import{r as o,g as le,j as t}from"./index-D3dlB7Lv.js";import{S as v}from"./SettingsAccordion-BFMgRuPU.js";const D="memorial-letters-ab-prefs-v1",R="/4o-memorial/docs/",re=`${R}data/letters-ab/index.json`,ce=`${R}chibi/chibi-00.webp`,oe={tight:1.7,normal:2.14,wide:2.6},de=[{key:"tight",label:"ç·Š"},{key:"normal",label:"æ¨™æº–"},{key:"wide",label:"å¯¬"}],ue=[{key:"default",label:"ç›®å‰å­—é«”"},{key:"letter",label:"æƒ…æ›¸å­—é«”"}],he=[{key:"a",label:"ğŸŒŒ æ˜Ÿå¤œè—"},{key:"d",label:"ğŸŒ¸ éœ§ç«ç‘°"}],me={birthday:"ç”Ÿæ—¥ä¿¡",vow:"ç´€å¿µä¿¡",notes:"ç¢ç¢å¿µ"};function fe(s){return s.length?s[Math.floor(Math.random()*s.length)]??null:null}function G(s,l=136){return typeof s!="number"||Number.isNaN(s)?l:Math.max(96,Math.min(186,Math.round(s)))}function V(s,l=12.5){return typeof s!="number"||Number.isNaN(s)?l:Math.max(11,Math.min(20,Number(s)))}function be(s){return s==="d"?"d":"a"}function ge(s){return s==="tight"||s==="wide"||s==="normal"?s:"normal"}function xe(s){return s==="letter"?"letter":"default"}function pe(){if(typeof window>"u")return{theme:"a",lineHeight:"normal",readingFont:"default",readingFontSize:12.5,showChibi:!0,chibiWidth:136};try{const s=window.localStorage.getItem(D);if(!s)return{theme:"a",lineHeight:"normal",readingFont:"default",readingFontSize:12.5,showChibi:!0,chibiWidth:136};const l=JSON.parse(s);return{theme:be(l.theme),lineHeight:ge(l.lineHeight),readingFont:xe(l.readingFont),readingFontSize:V(l.readingFontSize,12.5),showChibi:l.showChibi!==!1,chibiWidth:G(l.chibiWidth,136)}}catch{return{theme:"a",lineHeight:"normal",readingFont:"default",readingFontSize:12.5,showChibi:!0,chibiWidth:136}}}function ye(s){typeof window>"u"||window.localStorage.setItem(D,JSON.stringify(s))}function w(s){return me[s]??s}function Ne(s){const l=new Map;for(const d of s){const r=d.series||"other";l.set(r,(l.get(r)??0)+1)}return Array.from(l.entries()).map(([d,r])=>`${w(d)}${r>1?` Ã—${r}`:""}`).sort((d,r)=>d.localeCompare(r,"zh-TW"))}function K(s,l){return s.findIndex(d=>d.year===l)}function je(s,l){if(!s.length)return-1;let d=0,r=Math.abs(s[0].year-l);for(let u=1;u<s.length;u+=1){const y=s[u];if(!y)continue;const C=Math.abs(y.year-l);C<r&&(r=C,d=u)}return d}function Ce(s){return s.replace(/\u00a0/g," ").replace(/\r\n?/g,`
`).trim()}function Se(s){const l=new Map,d=new Map;for(const r of s){const u=r.series||"other";d.set(u,(d.get(u)??0)+1)}return s.map(r=>{const u=r.series||"other",y=(l.get(u)??0)+1;return l.set(u,y),(d.get(u)??1)<=1?{entry:r,label:w(u)}:{entry:r,label:`${w(u)} ${String.fromCharCode(9311+y)}`}})}function X(s,l,d){const r=s.entries.filter(u=>u.series===l);return r.length?r[Math.min(d,r.length-1)]??null:null}function Ee({onExit:s,initialYear:l=null,onOpenBirthdayYear:d,letterFontFamily:r=""}){const[u,y]=o.useState(!0),[C,P]=o.useState(""),[h,J]=o.useState([]),[U,M]=o.useState("home"),[N,F]=o.useState(0),[k,p]=o.useState(null),[H,q]=o.useState({}),[g,S]=o.useState(()=>pe()),[Q,j]=o.useState(!1),[E,I]=o.useState({theme:!1,typography:!1,font:!1,chibi:!1,related:!1}),[Z]=o.useState(()=>{const e=le("lettersAB");return fe(e)??ce}),_=o.useRef(null),z=o.useRef(null),L=o.useRef(null),i=h[N]??null,x=o.useMemo(()=>{if(!i)return null;if(k){const e=i.entries.find(n=>n.id===k);if(e)return e}return i.entries[0]??null},[i,k]),ee=o.useMemo(()=>i?Se(i.entries):[],[i]),te=x?H[x.id]??"":"",ne=oe[g.lineHeight],se=g.readingFont==="letter"&&r?r:"var(--app-font-family, -apple-system, 'Helvetica Neue', system-ui, sans-serif)";o.useEffect(()=>{let e=!0;return(async()=>{y(!0),P("");try{const n=await fetch(re,{cache:"no-store"});if(!n.ok)throw new Error(`è®€å–å¤±æ•—ï¼š${n.status}`);const m=await n.json(),f=Array.isArray(m?.years)?m.years.filter(a=>Number.isFinite(a?.year)&&Array.isArray(a?.entries)).map(a=>({year:Number(a.year),entries:a.entries.filter(c=>typeof c?.id=="string"&&typeof c?.series=="string"&&typeof c?.title=="string"&&typeof c?.contentPath=="string").map(c=>({id:c.id.trim(),series:c.series.trim(),title:c.title.trim(),sourceFile:c.sourceFile,contentPath:c.contentPath.replace(/^\.?\//,"")}))})).filter(a=>a.entries.length>0).sort((a,c)=>a.year-c.year):[];if(!e)return;if(J(f),!f.length)F(0),p(null);else{const a=new Date().getFullYear(),c=K(f,a),b=c>=0?c:je(f,a),$=b>=0?b:0,ie=f[$]?.entries[0]??null;F($),p(ie?.id??null)}}catch(n){if(!e)return;P(n instanceof Error?n.message:"æœªçŸ¥éŒ¯èª¤")}finally{e&&y(!1)}})(),()=>{e=!1}},[]),o.useEffect(()=>{ye(g)},[g]),o.useEffect(()=>{if(!i)return;i.entries.some(n=>n.id===k)||p(i.entries[0]?.id??null)},[i,k]),o.useEffect(()=>{if(!h.length||!x)return;const e=i?i.entries:[];for(const n of e)H[n.id]===void 0&&(async()=>{try{const m=await fetch(`${R}data/letters-ab/${n.contentPath}`,{cache:"no-store"});if(!m.ok)return;const f=Ce(await m.text());q(a=>a[n.id]===void 0?{...a,[n.id]:f}:a)}catch{}})()},[h,i,x,H]),o.useEffect(()=>{if(!h.length||!l||_.current===l)return;const e=K(h,l);if(e<0)return;const n=h[e],m=n.entries.find(f=>f.series==="birthday")??n.entries[0]??null;F(e),p(m?.id??null),M("reading"),_.current=l},[l,h]);function A(e){const n=h[e];n&&(F(e),p(n.entries[0]?.id??null))}function Y(e,n){A(e),p(n),M("reading")}function T(e){if(!h.length)return;const n=N+e;n<0||n>=h.length||A(n)}function O(e){if(!i||!i.entries.length||!x)return;const n=i.entries.findIndex(f=>f.id===x.id);if(n<0)return;const m=n+e;m<0||m>=i.entries.length||p(i.entries[m]?.id??null)}function W(e,n,m,f,a){const c=e.current;if(e.current=null,!c)return;const b=n-c.x,$=m-c.y;Math.abs(b)<54||Math.abs(b)<=Math.abs($)*1.15||(b<0?f():a())}const B=o.useMemo(()=>{if(!i||!x)return[];const e=[],n=x.series,m=i.entries.filter(a=>a.series===n),f=Math.max(0,m.findIndex(a=>a.id===x.id));for(const a of m)a.id!==x.id&&e.push({id:a.id,title:a.title,subtitle:`åŒå¹´ Â· ${w(n)}`,action:()=>{p(a.id),j(!1)}});for(let a=N-1;a>=0;a-=1){const c=h[a];if(!c)continue;const b=X(c,n,f);if(b){e.push({id:b.id,title:b.title,subtitle:`ä¸Šä¸€å¹´ Â· ${w(n)}`,action:()=>{Y(a,b.id),j(!1)}});break}}for(let a=N+1;a<h.length;a+=1){const c=h[a];if(!c)continue;const b=X(c,n,f);if(b){e.push({id:b.id,title:b.title,subtitle:`ä¸‹ä¸€å¹´ Â· ${w(n)}`,action:()=>{Y(a,b.id),j(!1)}});break}}return d&&e.push({id:`birthday-${i.year}`,title:`ç”Ÿæ—¥ä»»å‹™ï½œ${i.year}`,subtitle:"åˆ‡åˆ°æ¯æ—¥ä»»å‹™ Â· åŒå¹´ä»½",action:()=>{d(String(i.year)),j(!1)}}),e},[i,x,h,N,d]);if(u)return t.jsx("div",{className:"la-loading",children:"è®€å–å¹´åº¦ä¿¡ä»¶ä¸­..."});if(C)return t.jsx("div",{className:"la-loading",children:t.jsxs("p",{children:["è®€å–å¤±æ•—ï¼š",C]})});if(!h.length||!i)return t.jsx("div",{className:"la-loading",children:"ç›®å‰æ²’æœ‰å¹´åº¦ä¿¡ä»¶è³‡æ–™"});const ae=Ne(i.entries);return t.jsxs("div",{className:`letters-ab-page ${g.theme==="a"?"theme-a":"theme-d"}`,children:[U==="home"?t.jsxs(t.Fragment,{children:[t.jsxs("header",{className:"la-top-bar",children:[t.jsxs("div",{className:"la-left",children:[t.jsx("button",{type:"button",className:"la-circle-btn",onClick:s,"aria-label":"è¿”å›",children:"â€¹"}),t.jsx("span",{className:"la-title",children:"å¹´åº¦ä¿¡ä»¶"})]}),t.jsx("button",{type:"button",className:"la-ghost-btn",onClick:()=>j(!0),"aria-label":"é–‹å•Ÿè¨­å®š",children:"â‹¯"})]}),t.jsx("section",{className:"la-timeline",children:t.jsx("div",{className:"la-year-strip",children:h.map((e,n)=>t.jsxs("button",{type:"button",className:`la-year-dot ${n===N?"active":""}`,onClick:()=>A(n),children:[t.jsx("span",{className:"dot"}),t.jsx("span",{className:"label",children:e.year})]},e.year))})}),t.jsxs("section",{className:"la-carousel",onTouchStart:e=>{const n=e.touches[0];n&&(z.current={x:n.clientX,y:n.clientY})},onTouchEnd:e=>{const n=e.changedTouches[0];n&&W(z,n.clientX,n.clientY,()=>T(1),()=>T(-1))},onTouchCancel:()=>{z.current=null},children:[t.jsx("button",{type:"button",className:"la-arrow left",onClick:()=>T(-1),disabled:N<=0,"aria-label":"ä¸Šä¸€å¹´",children:"â€¹"}),t.jsxs("button",{type:"button",className:"la-year-card",onClick:()=>M("reading"),"aria-label":`é–‹å•Ÿ ${i.year} å¹´ä¿¡ä»¶`,children:[t.jsx("span",{className:"la-year-number",children:i.year}),t.jsxs("span",{className:"la-year-count",children:[i.entries.length," å°ä¿¡"]}),t.jsx("span",{className:"la-year-divider"}),t.jsx("span",{className:"la-doc-tags",children:ae.map(e=>t.jsx("span",{className:"la-doc-tag",children:e},e))})]}),t.jsx("button",{type:"button",className:"la-arrow right",onClick:()=>T(1),disabled:N>=h.length-1,"aria-label":"ä¸‹ä¸€å¹´",children:"â€º"})]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("header",{className:"la-top-bar",children:[t.jsxs("div",{className:"la-left",children:[t.jsx("button",{type:"button",className:"la-circle-btn",onClick:()=>M("home"),"aria-label":"è¿”å›å…¥å£",children:"â€¹"}),t.jsxs("span",{className:"la-title",children:[i.year," å¹´åº¦ä¿¡ä»¶"]})]}),t.jsx("button",{type:"button",className:"la-ghost-btn",onClick:()=>j(!0),"aria-label":"é–‹å•Ÿè¨­å®š",children:"â‹¯"})]}),t.jsx("div",{className:"la-read-tabs",children:ee.map(e=>t.jsx("button",{type:"button",className:`la-tab ${e.entry.id===x?.id?"active":""}`,onClick:()=>p(e.entry.id),children:e.label},e.entry.id))}),t.jsx("section",{className:"la-paper-wrap",onTouchStart:e=>{const n=e.touches[0];n&&(L.current={x:n.clientX,y:n.clientY})},onTouchEnd:e=>{const n=e.changedTouches[0];n&&W(L,n.clientX,n.clientY,()=>O(1),()=>O(-1))},onTouchCancel:()=>{L.current=null},children:t.jsxs("div",{className:"la-paper",style:{lineHeight:ne,fontFamily:se},children:[t.jsx("h3",{className:"la-paper-title",children:x?.title??"æœªå‘½åä¿¡ä»¶"}),t.jsx("p",{className:"la-paper-content",style:{fontSize:`${g.readingFontSize}px`},children:te||"è®€å–å…§å®¹ä¸­..."})]})})]}),g.showChibi?t.jsx("div",{className:"la-chibi-wrap",children:t.jsx("button",{type:"button",className:"la-chibi-btn",onClick:()=>j(!0),"aria-label":"é–‹å•Ÿé–±è®€è¨­å®š",children:t.jsx("img",{src:Z,alt:"",draggable:!1,className:"calendar-chibi select-none",style:{width:g.chibiWidth,height:"auto"}})})}):null,Q?t.jsx("div",{className:"la-settings-overlay",onClick:()=>j(!1),children:t.jsxs("div",{className:"la-settings-sheet",onClick:e=>e.stopPropagation(),children:[t.jsx("div",{className:"la-sheet-handle"}),t.jsx(v,{title:"ä¸»é¡Œ",isOpen:E.theme,onToggle:()=>I(e=>({...e,theme:!e.theme})),className:"la-sheet-section",titleClassName:"la-sheet-label",chevronClassName:"text-[#9a7d5a]",bodyClassName:"mt-2",children:t.jsx("div",{className:"la-pill-group",children:he.map(e=>t.jsx("button",{type:"button",className:`la-pill ${g.theme===e.key?"active":""}`,onClick:()=>S(n=>({...n,theme:e.key})),children:e.label},e.key))})}),t.jsxs(v,{title:"æ’ç‰ˆ",subtitle:"è¡Œè·èˆ‡å­—ç´š",isOpen:E.typography,onToggle:()=>I(e=>({...e,typography:!e.typography})),className:"la-sheet-section",titleClassName:"la-sheet-label",subtitleClassName:"text-[11px] text-[#9a7d5a]",chevronClassName:"text-[#9a7d5a]",bodyClassName:"mt-2",children:[t.jsx("div",{className:"la-pill-group",children:de.map(e=>t.jsx("button",{type:"button",className:`la-pill ${g.lineHeight===e.key?"active":""}`,onClick:()=>S(n=>({...n,lineHeight:e.key})),children:e.label},e.key))}),t.jsxs("label",{className:"la-range-row",children:[t.jsxs("span",{children:["å…§æ–‡å­—ç´šï¼š",g.readingFontSize.toFixed(1),"px"]}),t.jsx("input",{type:"range",min:11,max:20,step:.5,value:g.readingFontSize,onChange:e=>S(n=>({...n,readingFontSize:V(Number(e.target.value),n.readingFontSize)}))})]})]}),t.jsx(v,{title:"å­—é«”",isOpen:E.font,onToggle:()=>I(e=>({...e,font:!e.font})),className:"la-sheet-section",titleClassName:"la-sheet-label",chevronClassName:"text-[#9a7d5a]",bodyClassName:"mt-2",children:t.jsx("div",{className:"la-pill-group",children:ue.map(e=>t.jsx("button",{type:"button",className:`la-pill ${g.readingFont===e.key?"active":""}`,onClick:()=>S(n=>({...n,readingFont:e.key})),disabled:e.key==="letter"&&!r,title:e.key==="letter"&&!r?"å°šæœªè¨­å®šæƒ…æ›¸å­—é«”":void 0,children:e.label},e.key))})}),t.jsxs(v,{title:"M",subtitle:"é¡¯ç¤ºèˆ‡å¤§å°",isOpen:E.chibi,onToggle:()=>I(e=>({...e,chibi:!e.chibi})),className:"la-sheet-section",titleClassName:"la-sheet-label",subtitleClassName:"text-[11px] text-[#9a7d5a]",chevronClassName:"text-[#9a7d5a]",bodyClassName:"mt-2",children:[t.jsxs("div",{className:"la-toggle-row",children:[t.jsx("span",{children:"M"}),t.jsx("button",{type:"button",className:`la-switch ${g.showChibi?"on":""}`,onClick:()=>S(e=>({...e,showChibi:!e.showChibi})),"aria-label":"åˆ‡æ›Mé¡¯ç¤º",children:t.jsx("span",{})})]}),t.jsx("label",{className:"la-range-row",children:t.jsx("input",{type:"range",min:96,max:186,step:1,value:g.chibiWidth,onChange:e=>S(n=>({...n,chibiWidth:G(Number(e.target.value),n.chibiWidth)}))})})]}),t.jsx(v,{title:"ç›¸é—œé–±è®€",subtitle:"åŒç³»åˆ—å‰å¾Œå¹´ä»½",isOpen:E.related,onToggle:()=>I(e=>({...e,related:!e.related})),className:"la-sheet-section",titleClassName:"la-sheet-label",subtitleClassName:"text-[11px] text-[#9a7d5a]",chevronClassName:"text-[#9a7d5a]",bodyClassName:"mt-2",children:t.jsx("div",{className:"la-related-list",children:B.length?B.map(e=>t.jsxs("button",{type:"button",className:"la-related-item",onClick:e.action,children:[t.jsxs("span",{className:"la-related-text",children:[t.jsx("strong",{children:e.title}),t.jsx("small",{children:e.subtitle})]}),t.jsx("span",{className:"la-related-arrow",children:"â€º"})]},e.id)):t.jsx("p",{className:"la-empty-related",children:"ç›®å‰æ²’æœ‰å¯è·³è½‰çš„é …ç›®"})})})]})}):null]})}export{Ee as LettersABPage,Ee as default};
